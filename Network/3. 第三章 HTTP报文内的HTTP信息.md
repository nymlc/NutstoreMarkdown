本章主要是了解下请求和响应是怎样运作的

# HTTP报文

报文就是`HTTP`协议交互的信息，它是由多行（用 CR+LF 作换行符）数据构成的字符串文本

> 其实是打印机的一个问题，回车（carriage return）是告诉打印机把打印头定位在左边界，换行（line feed）是告诉打印机把纸向下移一行
>
> 这个概念也被搬到了计算机，不过只有`Windows`是回车换行，`Mac、Linux`是只有换行
>
> 回车（`\r`）、换行（`\n`）

报文大致分为首部、主体，主体（也就是数据）不一定会有，它们被第一次出现的空行（CR+LF）隔开

<img src="https://cdn.jsdelivr.net/gh/nymlc/picgo@master/uPic/1616579304473.png" alt="image-20200525001626603" style="zoom:50%;" />

# 请求报文及响应报文的结构

报文结构大致如下

<img src="https://cdn.jsdelivr.net/gh/nymlc/picgo@master/uPic/1616579329878.png" alt="image-20200525001753053" style="zoom:50%;" />

可见其实请求报文和响应报文大体相同，关注下首部字段划分，其实无论请求还是响应俩者有通用之处

<img src="https://cdn.jsdelivr.net/gh/nymlc/picgo@master/uPic/1616579436222.png" alt="image-20200525002004255" style="zoom:50%;" />

如图可详见请求和响应报文的区别

# 编码提升传输速率

传输数据的时候可以按照数据原样传输，但是也可以在传输的时候通过编码（压缩）来提升传输效率

## 报文主体和实体主体的差异

+ 报文是`HTTP`通信中的基本单位，由8位组字节流组成，通过`HTTP`通信传输
+ 实体通常情况下就是报文主体，它由实体首部和主体构成，承载着我们实际想要发送的内容

`HTTP`报文的主体就是用来传输实体主体，**可以理解为报文主体包含实体**

在传输中编码的时候报文主体就会包含多个实体，这样子各个实体就会有自己的实体首部、实体主体，各个实体由空行（CR+LF）隔开

## 压缩传输的内容编码

内容编码就像是我们压缩文件一样，内容编码格式有以下几种：

+ gzip（GNU zip） 
+ compress（UNIX 系统的标准压缩） 
+ deflate（zlib） 
+ identity（不进行编码）

## 分割发送的分块传输编码

我们请求一张很大的图片一般图片都是从上往下显示，不是一下子就全部显示出来，这种其实是**分块传输编码**的效果

分块传输编码会将实体分割成若干个块（chunk），每个块会以十六进制来标记块的大小，最后一个块会以“0（CR+LF）”来标记，客户端会解码复原成编码前的实体主体

`HTTP/1.1`中存在传输编码机制，在通信中按某种编码方式传输，但只作用于分块传输编码中

# 发送多种数据的多部分对象集合

我们邮件可以发送带有文字、附件的邮件，这是因为采用了`MIME（Multipurpose Internet Mail Extensions，多用途因特网邮
件扩展）`，



# 获取部分内容的范围请求

恢复下载就是在已经下载完的不管，从未下载的地方继续下载。这就需要指定下载的实体范围这就是**范围请求**

就像1000字节的资源，我可以请求500~1000的部分

<img src="https://cdn.jsdelivr.net/gh/nymlc/picgo@master/uPic/1628062454132.png" alt="image-20210804153401243" style="zoom:50%;" />

请求的首部字段`Range`来指定资源的`byte`范围

+ 5000~10000字节：Range: bytes=5001-10000
+ 5001字节之后全部：Range: bytes=5001-
+ 开始到3000字节和5000到7000字节，多重范围：Range: bytes=-3000,5000-7000

范围请求响应会返回状态码206（Partial Content），多重范围请求的响应会在首部字段`Content-Type`标明`multipart/byteranges`

服务器无法响应范围请求则会返回状态码200以及完整的实体内容

# 内容协商返回最合适的内容

我们访问`Apple`官网会发现它会根据你的浏览器语言情况适配到中英文页面，这就是内容协商（Content Negotiation）

它指的是客户端和服务端就响应的资源内容进行交涉然后提供客户端合适的资源。它以响应资源的语言、字符集、编码方式等作为评定标准

以下几个首部字段就是判定标准：Accept、Accept-Charset、Accept-Encoding、Accept-Language、Content-Language

内容协商有以下三种类型：

+ 服务器驱动协商：就是以请求首部字段作为参考在服务端处理
+ 客户端驱动协商：用户在浏览器上自行选择，可以用`JS`来自行判断切换
+ 透明协商：结合以上俩者

